define(["jquery","core/ajax"],function(a,b){a(document.body).addClass("jschooser");var c={panel:null,loadingDiv:"",prepare_chooser:function(){if(!this.panel){var b={headerContent:"TODO",bodyContent:a("div.questionbankloading").parent().html(),draggable:!0,modal:!0,centered:!0,width:null,visible:!1,postmethod:"form",footerContent:null,extraClasses:["mod_adaptivequiz_qbank_dialogue"]};this.panel=new M.core.dialogue(b),this.panel.hide(),this.panel.render(),this.loadingDiv=this.panel.bodyNode.getHTML()}},display_chooserdialogue:function(b){this.prepare_chooser(),b.preventDefault(),this.panel.bodyNode.setHTML(a("div.questionbankloading").parent().html()),this.panel.show(),this.load()},get_href_param:function(a,b){for(var c=a.split("?")[1],d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(f[0]==b)return f[1]}return null},questionbank_loaded:function(b){this.panel.bodyNode.setHTML(b),this.panel.centerDialogue(),a(".addfromquestionbank").click(function(b){b.preventDefault();var c=a("<input>").attr("type","hidden").attr("name","addfromquestionbank").val(a(this).data("id"));a("#blockeditingform").append(a(c)),a("#blockeditingform").submit()}),a(".questionbankcontent").find("a").click(a.proxy(this.link_clicked,this)),a("#id_selectacategory").change(a.proxy(this.category_changed,this)),this.panel.fire("widget:contentUpdate"),this.panel.get("visible")&&(this.panel.hide(),this.panel.show())},category_changed:function(a){a.preventDefault(),this.load()},link_clicked:function(a){a.preventDefault();var b=this.get_href_param(a.target.href,"qpage"),c=this.get_href_param(a.target.href,"qperpage");(null!==b||null!==c)&&this.load(b,c)},load:function(c,d){var e={};e.cmid=a(".questionbank").data("cmid"),c&&(e.page=c),d&&(e.qperpage=d),e.category=a("#id_selectacategory").val(),this.panel.bodyNode.setHTML(a("div.questionbankloading").parent().html());var f=b.call([{methodname:"mod_adaptivequiz_get_questionbank",args:e}]);f[0].done(a.proxy(this.questionbank_loaded,this)).fail(a.proxy(this.questionbank_load_failed,this))},questionbank_load_failed:function(){this.panel.bodyNode.setHTML("Error fetching from question bank")}};return{init:function(){a(".questionbank").click(function(a){c.display_chooserdialogue(a)})}}});